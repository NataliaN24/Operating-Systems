Ð’Ð°ÑˆÐ¸Ñ‚Ðµ ÐºÐ¾Ð»ÐµÐ³Ð¸ Ð¾Ñ‚ ÑÑŠÑÐµÐ´Ð½Ð°Ñ‚Ð° Ð»Ð°Ð±Ð¾Ñ€Ð°Ñ‚Ð¾Ñ€Ð¸Ñ Ñ€Ð°Ð±Ð¾Ñ‚ÑÑ‚ ÑÑŠÑ ÑÐ¿ÐµÑ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð°Ð½Ð° ÑÐ¸ÑÑ‚ÐµÐ¼Ð° Fuga, ÐºÐ¾ÑÑ‚Ð¾ ÑÐµ Ð±Ð°Ð·Ð¸Ñ€Ð°
Ð½Ð° Ð´Ð²Ð° Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ð¸ Ñ„Ð°Ð¹Ð»Ð° â€“ Ð·Ð° Ð°Ð²Ñ‚ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ñ (foo.pwd) Ð¸ Ð¾ÑÐ½Ð¾Ð²ÐµÐ½ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¾Ð½ÐµÐ½ Ñ„Ð°Ð¹Ð» (foo.conf).
Ð”Ð²Ð°Ñ‚Ð° Ñ„Ð°Ð¹Ð»Ð° Ð±Ð¸ Ñ‚Ñ€ÑÐ±Ð²Ð°Ð»Ð¾ Ð´Ð° ÑÐµ ÑÑŠÑ…Ñ€Ð°Ð½ÑÐ²Ð°Ñ‚ Ð² Ð³Ð»Ð°Ð²Ð½Ð°Ñ‚Ð° Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ Ð½Ð° ÑÐ¸ÑÑ‚ÐµÐ¼Ð°Ñ‚Ð°, ÐºÐ¾ÑÑ‚Ð¾ Ñ‰Ðµ Ð½Ð°Ñ€Ð¸Ñ‡Ð°Ð¼Ðµ
fuga.
ÐÐ° Ð²ÑÐµÐºÐ¸ Ñ€ÐµÐ´ Ð²ÑŠÐ² Ð¿ÑŠÑ€Ð²Ð¸Ñ Ñ„Ð°Ð¹Ð» Ð¸Ð¼Ð° Ð¿Ð¾Ñ‚Ñ€ÐµÐ±Ð¸Ñ‚ÐµÐ»ÑÐºÐ¾ Ð¸Ð¼Ðµ (Ð¼Ð°Ð»ÐºÐ¸ Ð»Ð°Ñ‚Ð¸Ð½ÑÐºÐ¸ Ð±ÑƒÐºÐ²Ð¸) Ð¸ Ð¿Ð°Ñ€Ð¾Ð»Ð°Ñ‚Ð° Ð·Ð° Ñ‚Ð¾Ð·Ð¸
Ð¿Ð¾Ñ‚Ñ€ÐµÐ±Ð¸Ñ‚ÐµÐ», Ñ€Ð°Ð·Ð´ÐµÐ»ÐµÐ½Ð¸ Ñ Ð´Ð²Ð¾ÐµÑ‚Ð¾Ñ‡Ð¸Ðµ, ÐºÐ°Ñ‚Ð¾ Ð¿Ð°Ñ€Ð¾Ð»Ð°Ñ‚Ð° Ð½Ðµ Ðµ Ð² Ñ‡Ð¸ÑÑ‚ Ð²Ð¸Ð´, Ð° Ðµ Ñ…ÐµÑˆÐ¸Ñ€Ð°Ð½Ð°.
Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ÑŠÑ‚ Ð½Ð° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ð¸Ñ Ñ„Ð°Ð¹Ð» Ðµ Ð½ÐµÐ´ÐµÑ„Ð¸Ð½Ð¸Ñ€Ð°Ð½. Ð¢ÑŠÐ¹ ÐºÐ°Ñ‚Ð¾ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ð¸ÑÑ‚ Ñ„Ð°Ð¹Ð» Ðµ Ñ‚Ð²ÑŠÑ€Ð´Ðµ
Ð³Ð¾Ð»ÑÐ¼ Ð·Ð° ÑƒÐ´Ð¾Ð±Ð½Ð° Ñ€Ð°Ð±Ð¾Ñ‚Ð°, Ð²Ð°ÑˆÐ¸Ñ‚Ðµ ÐºÐ¾Ð»ÐµÐ³Ð¸ ÑÐ° Ñ€ÐµÑˆÐ¸Ð»Ð¸ Ð´Ð° Ð³Ð¾ Ñ€Ð°Ð·Ð´ÐµÐ»ÑÑ‚ Ð½Ð° Ñ‡Ð°ÑÑ‚Ð¸ Ð² Ð¾Ñ‚Ð´ÐµÐ»Ð½Ð¸ Ð¼Ð°Ð»ÐºÐ¸ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ð¸ Ñ„Ð°Ð¹Ð»Ð¾Ð²Ðµ, ÐºÐ¾Ð¸Ñ‚Ð¾ Ð´ÑŠÑ€Ð¶Ð°Ñ‚ Ð² Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ fuga/cfg Ð¸ Ð½ÐµÐ¹Ð½Ð¸Ñ‚Ðµ Ð¿Ð¾Ð´-Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸. Ð’ÑÐµÐºÐ¸ Ñ‚Ð°ÐºÑŠÐ² Ñ„Ð°Ð¹Ð»
Ð¸Ð¼Ð° Ð¸Ð¼Ðµ Ð²ÑŠÐ² Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ bar.cfg, ÐºÑŠÐ´ÐµÑ‚Ð¾ bar Ðµ Ð¸Ð¼Ðµ Ð½Ð° Ð¿Ð¾Ñ‚Ñ€ÐµÐ±Ð¸Ñ‚ÐµÐ» Ð½Ð° ÑÐ¸ÑÑ‚ÐµÐ¼Ð°Ñ‚Ð°. ÐšÐ¾Ð»ÐµÐ³Ð¸Ñ‚Ðµ Ð²Ð¸ ÑÐ° Ð½Ð°Ð¿Ð¸ÑÐ°Ð»Ð¸
ÑÐºÑ€Ð¸Ð¿Ñ‚ (fuga/validate.sh), ÐºÐ¾Ð¹Ñ‚Ð¾ Ð¿Ñ€Ð¸ÐµÐ¼Ð° ÐµÐ´Ð¸Ð½ Ð·Ð°Ð´ÑŠÐ»Ð¶Ð¸Ñ‚ÐµÐ»ÐµÐ½ Ð¿Ð¾Ð·Ð¸Ñ†Ð¸Ð¾Ð½ÐµÐ½ Ð°Ñ€Ð³ÑƒÐ¼ÐµÐ½Ñ‚ â€“ Ð¸Ð¼Ðµ Ð½Ð° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¾Ð½ÐµÐ½ Ñ„Ð°Ð¹Ð». Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ÑŠÑ‚ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐ²Ð° ÑƒÐºÐ°Ð·Ð°Ð½Ð¸Ñ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¾Ð½ÐµÐ½ Ñ„Ð°Ð¹Ð» Ð·Ð° Ð²Ð°Ð»Ð¸Ð´ÐµÐ½ ÑÐ¸Ð½Ñ‚Ð°ÐºÑÐ¸Ñ Ð¸
Ð¼Ð¾Ð¶Ðµ Ð´Ð° Ð¿Ñ€Ð¸ÐºÐ»ÑŽÑ‡Ð¸ Ñ Ð½ÑÐºÐ¾Ð¹ Ð¾Ñ‚ ÑÐ»ÐµÐ´Ð½Ð¸Ñ‚Ðµ exit code-Ð¾Ð²Ðµ:
â€¢ 0 â€“ Ñ„Ð°Ð¹Ð»ÑŠÑ‚ Ðµ Ð²Ð°Ð»Ð¸Ð´ÐµÐ½;
â€¢ 1 â€“ Ñ„Ð°Ð¹Ð»ÑŠÑ‚ Ð½Ðµ Ðµ Ð²Ð°Ð»Ð¸Ð´ÐµÐ½;
â€¢ 2 â€“ Ð½Ð°ÑÑ‚ÑŠÐ¿Ð¸Ð»Ð° Ðµ Ð³Ñ€ÐµÑˆÐºÐ° Ð¿Ñ€Ð¸ Ð¸Ð·Ð¿ÑŠÐ»Ð½ÐµÐ½Ð¸Ðµ Ð½Ð° ÑÐºÑ€Ð¸Ð¿Ñ‚Ð°.
ÐÐºÐ¾ Ñ„Ð°Ð¹Ð»ÑŠÑ‚ Ð½Ðµ Ðµ Ð²Ð°Ð»Ð¸Ð´ÐµÐ½, ÑÐºÑ€Ð¸Ð¿Ñ‚ÑŠÑ‚ Ð¸Ð·Ð²ÐµÐ¶Ð´Ð° Ð½Ð° stdout Ñ€ÐµÐ´Ð¾Ð²ÐµÑ‚Ðµ, Ð½Ð° ÐºÐ¾Ð¸Ñ‚Ð¾ Ð¸Ð¼Ð° Ð³Ñ€ÐµÑˆÐºÐ°, Ð¿Ñ€ÐµÐ´Ñ…Ð¾Ð¶Ð´Ð°Ð½Ð¸ Ð¾Ñ‚
Line x: ÐºÑŠÐ´ÐµÑ‚Ð¾ ð‘¥ Ðµ Ð½Ð¾Ð¼ÐµÑ€Ð° Ð½Ð° Ñ€ÐµÐ´Ð°. Ð’ Ð¾ÑÑ‚Ð°Ð½Ð°Ð»Ð¸Ñ‚Ðµ ÑÐ»ÑƒÑ‡Ð°Ð¸ ÑÐºÑ€Ð¸Ð¿Ñ‚ÑŠÑ‚ Ð½ÑÐ¼Ð° Ð¸Ð·Ñ…Ð¾Ð´.
Ð Ð°Ð·Ð¿Ð¾Ð»Ð°Ð³Ð°Ñ‚Ðµ Ñ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð° pwgen, ÐºÐ¾ÑÑ‚Ð¾ Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð° Ð¸ Ð¸Ð·Ð²ÐµÐ¶Ð´Ð° Ð½Ð° stdout ÑÐ»ÑƒÑ‡Ð°Ð¹Ð½Ð¸ Ð¿Ð°Ñ€Ð¾Ð»Ð¸ (Ð±ÑƒÐºÐ²Ð¸ Ð¸ Ñ†Ð¸Ñ„Ñ€Ð¸),
Ð¸ Ð·Ð½Ð°ÐµÑ‚Ðµ, Ñ‡Ðµ Ð¿Ð¾Ð´Ð´ÑŠÑ€Ð¶Ð° ÑÐ»ÐµÐ´Ð½Ð¸Ñ‚Ðµ Ð´Ð²Ð° Ð°Ñ€Ð³ÑƒÐ¼ÐµÐ½Ñ‚Ð°: pwgen [password_length] [number_of_passwords]
Ð¡ÑŠÑ‰Ð¾ Ñ‚Ð°ÐºÐ° Ñ€Ð°Ð·Ð¿Ð¾Ð»Ð°Ð³Ð°Ñ‚Ðµ Ñ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð°Ñ‚Ð° mkpasswd, ÐºÐ¾ÑÑ‚Ð¾ Ð¿Ð¾ Ð¿Ð¾Ð´Ð°Ð´ÐµÐ½ Ð°Ñ€Ð³ÑƒÐ¼ÐµÐ½Ñ‚ â€“ Ð¿Ð°Ñ€Ð¾Ð»Ð° Ð² Ñ‡Ð¸ÑÑ‚ Ð²Ð¸Ð´ Ð¸Ð·Ð²ÐµÐ¶Ð´Ð°
Ð½ÐµÐ¹Ð½Ð¸ÑÑ‚ Ñ…ÐµÑˆ Ð½Ð° stdout.
ÐŸÐ¾Ð¼Ð¾Ð³Ð½ÐµÑ‚Ðµ Ð½Ð° ÐºÐ¾Ð»ÐµÐ³Ð¸Ñ‚Ðµ ÑÐ¸, ÐºÐ°Ñ‚Ð¾ Ð½Ð°Ð¿Ð¸ÑˆÐµÑ‚Ðµ ÑˆÐµÐ» ÑÐºÑ€Ð¸Ð¿Ñ‚, ÐºÐ¾Ð¹Ñ‚Ð¾ Ð¿Ñ€Ð¸ÐµÐ¼Ð° Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚ÑŠÑ€ â€“ Ð¸Ð¼Ðµ Ð½Ð° Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ
fuga. Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ÑŠÑ‚ Ñ‚Ñ€ÑÐ±Ð²Ð° Ð´Ð°:
â€¢ Ð¸Ð·Ð²ÐµÐ¶Ð´Ð° Ð½Ð° stderr Ð³Ñ€ÐµÑˆÐ½Ð¸Ñ‚Ðµ Ñ€ÐµÐ´Ð¾Ð²Ðµ Ð¾Ñ‚ Ð¼Ð°Ð»ÐºÐ¸Ñ‚Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ð¸ Ñ„Ð°Ð¹Ð»Ð¾Ð²Ðµ, Ð²ÑŠÐ² Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð° Ð¸Ð·Ð²ÐµÐ¶Ð´Ð°Ð½ Ð¾Ñ‚ Ð²Ð°Ð»Ð¸Ð´Ð¸Ñ€Ð°Ñ‰Ð¸Ñ ÑÐºÑ€Ð¸Ð¿Ñ‚, ÐºÐ°Ñ‚Ð¾ Ð²ÑÐµÐºÐ¸ Ñ€ÐµÐ´ Ñ‚Ñ€ÑÐ±Ð²Ð° Ð´Ð° Ð·Ð°Ð¿Ð¾Ñ‡Ð²Ð° Ñ Ð¸Ð¼ÐµÑ‚Ð¾ Ð½Ð° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ð¸Ñ
Ñ„Ð°Ð¹Ð» Ð¸ Ð·Ð½Ð°Ðº Ð´Ð²Ð¾ÐµÑ‚Ð¾Ñ‡Ð¸Ðµ â€™:â€™;
â€¢ (Ñ€Ðµ-)Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð° foo.conf ÐºÐ°Ñ‚Ð¾ ÐºÐ¾Ð½ÐºÐ°Ñ‚ÐµÐ½Ð°Ñ†Ð¸Ñ Ð½Ð° Ð²Ð°Ð»Ð¸Ð´Ð½Ð¸Ñ‚Ðµ Ð¼Ð°Ð»ÐºÐ¸ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ð¸ Ñ„Ð°Ð¹Ð»Ð¾Ð²Ðµ;
â€¢ Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¸ Ð·Ð° Ð²ÑÐµÐºÐ¸ Ð²Ð°Ð»Ð¸Ð´ÐµÐ½ Ð¼Ð°Ð»ÑŠÐº ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¾Ð½ÐµÐ½ Ñ„Ð°Ð¹Ð» Ð´Ð°Ð»Ð¸ Ð¿Ð¾Ñ‚Ñ€ÐµÐ±Ð¸Ñ‚ÐµÐ»ÑÑ‚ ÑÑŠÑ‰ÐµÑÑ‚Ð²ÑƒÐ²Ð° Ð² Ð°Ð²Ñ‚ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¾Ð½Ð½Ð¸Ñ Ñ„Ð°Ð¹Ð» Ð¸ Ð°ÐºÐ¾ Ð½Ðµ â€“ Ð´Ð° Ð³Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð¸ Ð¿Ð¾ Ð¿Ð¾Ð´Ñ…Ð¾Ð´ÑÑ‰Ð¸Ñ Ð½Ð°Ñ‡Ð¸Ð½, ÐºÐ°Ñ‚Ð¾ Ð¸Ð·Ð²ÐµÐ´Ðµ Ð½Ð° stdout
Ð¿Ð¾Ñ‚Ñ€ÐµÐ±Ð¸Ñ‚ÐµÐ»ÑÐºÐ¾Ñ‚Ð¾ Ð¸Ð¼Ðµ Ð¸ Ð¿Ð°Ñ€Ð¾Ð»Ð°Ñ‚Ð° Ð² Ñ‡Ð¸ÑÑ‚ Ð²Ð¸Ð´, Ñ€Ð°Ð·Ð´ÐµÐ»ÐµÐ½Ð¸ Ñ Ð´Ð²Ð¾ÐµÑ‚Ð¾Ñ‡Ð¸Ðµ.

#!/bin/bash

if [ -z "$1" ]; then
    echo "Usage: $0 fuga_dir" >&2
    exit 1
fi

FUGA_DIR="$1"
CFG_DIR="$FUGA_DIR/cfg"
PWD_FILE="$FUGA_DIR/foo.pwd"
OUT_CONF="$FUGA_DIR/foo.conf"

> "$OUT_CONF"

find "$CFG_DIR" -type f -name "*.cfg" | while read -r cfgfile; do

    "$FUGA_DIR/validate.sh" "$cfgfile"
    EXIT_CODE=$?
    if [ $EXIT_CODE -eq 0 ]; then
      
        cat "$cfgfile" >> "$OUT_CONF"
     
        USERNAME=$(basename "$cfgfile" .cfg)
       
        if ! grep -q "^$USERNAME:" "$PWD_FILE"; then
          
            PASSWORD=$(pwgen 16 1)
            HASH=$(mkpasswd "$PASSWORD")
      
            echo "$USERNAME:$HASH" >> "$PWD_FILE"
            
            echo "$USERNAME:$PASSWORD"
        fi
    elif [ $EXIT_CODE -eq 1 ]; then
   
        "$FUGA_DIR/validate.sh" "$cfgfile" | sed "s|^|$cfgfile:|"
    else

        echo "Error processing $cfgfile" >&2
    fi
done

